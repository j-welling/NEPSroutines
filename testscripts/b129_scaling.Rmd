
---
title: "Scaling study  B129 (Reading) with the scaling package"
author: "Jana Welling"
date: "`r Sys.time()`"
output:
    html_document:
        toc: true
        number_sections: true
        toc_float: true
        theme: readable
        highlight: tango
        df_print: paged
        code_folding: show
editor_options: 
  chunk_output_type: console
---

# Preparation of R and data

## Set working directory

```{r working directory}
setwd('Z:/Projektgruppen_(08)/Kompetenzen_BA_Hiwi_(p000012)/Methoden/Skalierung/Skalierungspaket')
```

## Load data

```{r load-data, warning = FALSE, message = FALSE, comment = NA, results = 'hide'}
rm(list = ls())
load(here::here('Test/B129/Version 1.2.0/Data/data.Rdata'))
#load('Z:/Projektgruppen_(08)/Kompetenzen_BA_Hiwi_(p000012)/Methoden/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Data/data.Rdata')
```

## Load scaling package

```{r load-scaling, warning = FALSE, message = FALSE, comment = NA, results = 'hide', eval = FALSE}
pkgload::load_all(here::here('scaling'))
#pkgload::load_all('Z:/Projektgruppen_(08)/Kompetenzen_BA_Hiwi_(p000012)/Methoden/Skalierung/Skalierungspaket/scaling')
```

# Debugging

```{r 'debugging', eval = FALSE}

```

# Sample and booklet descriptives

```{r descriptives}
# Sample size by (in)valid cases
scaling::n_valid(resp = resp, valid = 'valid')

# Sample size by test version
scaling::sample_by_group(
  resp = resp,
  grouping_variable = 'difficulty',
  labels = c('EasyTestlet' = 0, 'DifficultTestlet' = 1),
  save = TRUE,
  overwrite = TRUE,
  path = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables'
)

# Descriptives (mean, sd, etc.) of continuous variables
scaling::desc_con(resp = resp, desc = 'age', valid = 'valid')

# Descriptives (attributes, frequency) of nominal sociodemographic variables
sdv = c('sex', 'attendsGymnasium', 'migration', 'books')
scaling::desc_nom(resp = resp, desc = sdv, valid = 'valid')
scaling::show_attributes(resp = resp, desc = sdv)
rm(sdv)

# Descriptives (attributes, frequency) of nominal booklet variables
scaling::desc_nom(resp = resp, desc = 'difficulty', valid = 'valid')
scaling::show_attributes(resp = resp, desc = c('difficulty'))

# Item type by test version
scaling::props_by_group(
  vars = vars,
  select = 'mixed',
  grouping = c('easy', 'difficult'),
  properties = c('text_type', 'kog_type', 'type'),
  labels = list(
    text_type = c(
      Advertising = 1,
      Information = 2,
      Instruction = 3,
      Literary = 4,
      Commenting= 5
      ),
    kog_type = c(
      Finding_information = 1,
      Drawing_conclusions = 2,
      Reflecting = 3
      )
    ),
  save = TRUE,
  overwrite = TRUE,
  path = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables'
)
```


# Missing responses analyses

## Missing responses by person

```{r missing responses by person}
scaling::mv_person(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  labels_mvs = labels_mvs,
  color = c('blue', 'green', 'purple'),
  plots = TRUE,
  print = TRUE,
  save = TRUE,
  return = FALSE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_plots = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Plots/Missing_Responses/by_person',
  show_all = TRUE,
  overwrite = TRUE,
  warn = TRUE,
  verbose = FALSE
)
```

## Missing responses by item

```{r missing responses by item}

stages = c('stage_1', 'stage_2', 'stage_3')

resp$stage_1 <- resp$stage_2 <- resp$stage_3 <- TRUE
resp$stage_2[1:258] <- FALSE
resp$stage_3[1:516] <- FALSE

vars$stage_1 <- c(rep(TRUE, 57), rep(FALSE, 115))
vars$stage_2 <- c(rep(FALSE, 57), rep(TRUE, 57), rep(FALSE, 58))
vars$stage_3 <- c(rep(FALSE, 114), rep(TRUE, 58))

scaling::mv_item(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  mvs = mvs[c(3, 1, 2, 4)],
  labels_mvs = labels_mvs,
  grouping = c('easy', 'difficult'),
  position = c(easy = 'position_easy_mixed', difficult = 'position_difficult_mixed'),
  #position = 'position',
  #stages = stages,
  color = c('blue', 'green', 'purple'),
  plots = TRUE,
  print = TRUE,
  save = TRUE,
  return = FALSE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_plots = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Plots/Missing_Responses/by_item',
  show_all = TRUE,
  overwrite = TRUE,
  warn = TRUE,
  verbose = FALSE
)
```

# IRT analyses (Rasch & 2PL)

```{r IRT analysis}
irt_dich <- scaling::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  scoring = NULL,
  plots = FALSE,
  save = FALSE,
  print = TRUE,
  return = TRUE,
  path_results = 'Results',
  path_table = 'Tables',
  path_plots = 'Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)

xsi_fixed_1p <- irt_dich$model.1pl$mod$xsi$xsi
names(xsi_fixed_1p) <- row.names(irt_dich$model.1pl$mod$xsi)

xsi_fixed_2p <- irt_dich$model.2pl$mod$xsi$xsi
names(xsi_fixed_2p) <- row.names(irt_dich$model.2pl$mod$xsi)

irt_dich_fixed <- scaling::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  xsi_fixed_1p = xsi_fixed_1p,
  xsi_fixed_2p = xsi_fixed_2p,
  scoring = NULL,
  plots = FALSE,
  save = FALSE,
  print = TRUE,
  return = TRUE,
  path_results = 'Results',
  path_table = 'Tables',
  path_plots = 'Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)

irt_poly <- scaling::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'irt_scoring',
  plots = FALSE,
  save = FALSE,
  print = TRUE,
  return = TRUE,
  path_results = 'Results',
  path_table = 'Tables',
  path_plots = 'Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)

xsi_fixed_pcm <- irt_poly$model.pcm$mod$xsi$xsi
names(xsi_fixed_pcm) <- row.names(irt_poly$model.pcm$mod$xsi)

xsi_fixed_gpcm <- irt_poly$model.gpcm$mod$xsi$xsi
names(xsi_fixed_gpcm) <- row.names(irt_poly$model.gpcm$mod$xsi)

irt_poly_fixed <- scaling::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'irt_scoring',
  xsi_fixed_1p = xsi_fixed_pcm,
  xsi_fixed_2p = xsi_fixed_gpcm,
  plots = FALSE,
  save = FALSE,
  print = TRUE,
  return = TRUE,
  path_results = 'Results',
  path_table = 'Tables',
  path_plots = 'Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)

irt_grouped <- scaling::grouped_irt_analysis(
  select = c(easy = 'dich_easy', difficult = 'dich_difficult', common = 'dich_common'),
  resp = resp,
  vars = vars,
  valid = 'valid',
  save = FALSE,
  print = TRUE,
  plots = FALSE,
  return = TRUE,
  overwrite = TRUE,
  path_results = 'Results',
  path_table = 'Tables',
  path_plots = 'Plots',
  verbose = FALSE
)

xsi_fixed_easy_1p <- irt_grouped$easy$model.1pl$mod$xsi$xsi
names(xsi_fixed_easy_1p) <- row.names(irt_grouped$easy$model.1pl$mod$xsi)
xsi_fixed_1p <- list(easy = xsi_fixed_easy_1p)

xsi_fixed_easy_2p <- irt_grouped$easy$model.2pl$mod$xsi$xsi
names(xsi_fixed_easy_2p) <- row.names(irt_grouped$easy$model.2pl$mod$xsi)
xsi_fixed_2p <- list(easy = xsi_fixed_easy_2p)

irt_grouped <- scaling::grouped_irt_analysis(
  select = c(easy = 'dich_easy', difficult = 'dich_difficult', common = 'dich_common'),
  resp = resp,
  vars = vars,
  valid = 'valid',
  xsi_fixed_1p = xsi_fixed_1p,
  xsi_fixed_2p = xsi_fixed_2p,
  save = FALSE,
  print = TRUE,
  plots = FALSE,
  return = TRUE,
  overwrite = TRUE,
  path_results = 'Results',
  path_table = 'Tables',
  path_plots = 'Plots',
  verbose = FALSE
)
```

# IRT analyses

## For all items

```{r single IRT analysis}
# Rasch and 2PL
scaling::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  scoring = NULL,
  plots = TRUE,
  save = TRUE,
  print = TRUE,
  return = FALSE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_plots = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)

# PCM and GPCM
scaling::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'irt_scoring',
  plots = TRUE,
  save = TRUE,
  print = TRUE,
  return = FALSE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_plots = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)
```

## For different test versions

```{r grouped IRT analysis}
# Rasch and 2PL
scaling::grouped_irt_analysis(
  select = c(easy = 'dich_easy', difficult = 'dich_difficult', common = 'dich_common'),
  resp = resp,
  vars = vars,
  valid = 'valid',
  save = TRUE,
  print = TRUE,
  plots = TRUE,
  return = FALSE,
  overwrite = TRUE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_plots = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Plots',
  verbose = FALSE
)

# PCM and GPCM
scaling::grouped_irt_analysis(
  select = c(easy = 'mixed_easy', difficult = 'mixed_difficult', common = 'mixed_common'),
  resp = resp,
  vars = vars,
  valid = 'valid',
  scoring = 'irt_scoring',
  save = TRUE,
  print = TRUE,
  plots = TRUE,
  return = FALSE,
  overwrite = TRUE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_plots = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Plots',
  verbose = FALSE
)
```


# DIF analysis

```{r dif analysis}
# For Rasch
scaling::dif_analysis(
  resp = resp,
  vars = vars,
  select = c('dich_common', 'dich', 'dich'),
  valid = 'valid',
  dif_vars = c('difficulty', 'sex', 'migration'),
  scoring = 'irt_scoring',
  overwrite = TRUE,
  print = TRUE,
  save = TRUE,
  return = FALSE,
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  verbose = FALSE
)

# For PCM
scaling::dif_analysis(
  resp = resp,
  vars = vars,
  select = c('mixed_common', 'mixed', 'mixed'),
  valid = 'valid',
  dif_vars = c('difficulty', 'sex', 'migration'),
  scoring = 'irt_scoring',
  overwrite = TRUE,
  print = TRUE,
  save = TRUE,
  return = FALSE,
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables',
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  verbose = FALSE
)
```


# Distractor analysis

```{r distractor analysis}
scaling::dis_analysis(
  resp = resp,
  vars = vars,
  valid = 'valid',
  select_raw = 'distan',
  print = TRUE,
  save = TRUE,
  overwrite = TRUE,
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables'
)
```


# Dimension analysis

```{r dimensionality analysis}

vars$kog_type <- as.numeric(vars$kog_type)
vars$text_type <- as.numeric(vars$text_type)

scaling::dim_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'dim_scoring',
  irtmodel = 'PCM2',
  dim = c('kog_type', 'text_type'),
  maxiter = 10,
  snodes = 5,
  return = TRUE,
  save = TRUE,
  print = TRUE,
  path_table = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Tables', 
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  overwrite = TRUE,
  verbose = FALSE
)

```


# Linking

Linking is not yet implemented in this package version. 


# Create scores

```{r scores}
scores <- scaling::create_scores(
  resp = resp,
  vars = vars,
  scoring = 'irt_scoring',
  score_name = 'reg7',
  select = 'mixed',
  valid = 'valid',
  wle = TRUE,
  sum_score = TRUE,
  sum_select = 'suf',
  num_cat = 'num_cat',
  path_results = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/Results',
  return = TRUE,
  save = TRUE
)
```


# Create SUF

```{r suf}
scaling::create_suf(
  resp = resp,
  vars = vars,
  select = 'suf',
  competence = 'Reading',
  scores = scores,
  score_name = 'reg7',
  mvs = NULL,
  items_labels = NULL,
  path = 'C:/Users/ba4eb5/Desktop/Skalierung/Skalierungspaket/Test/B129/Version 1.2.0/SUF',
  save = TRUE,
  return = FALSE,
  warn = TRUE
)

rm(scores)
```


# Session

```{r session-info}
sessionInfo()
```
