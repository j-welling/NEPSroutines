
---
title: "Test script B129"
author: "Jana Welling"
date: "`r Sys.time()`"
output:
  html_document:
  toc: true
  number_sections: true
  toc_float: true
  theme: readable
  highlight: tango
  df_print: paged
  code_folding: show
editor_options: 
  chunk_output_type: console
---
  
# Preparation of R and data
  
## Set working directory
```{r working directory}
#setwd(insert_path)
```

## Load data

```{r load-data, warning = FALSE, message = FALSE, comment = NA, results = 'hide'}
load(here::here('Test/B129/Version 1.1.0/Data/data.Rdata'))
```

## Load NEPSroutines package

```{r load-NEPSroutines, warning = FALSE, message = FALSE, comment = NA, results = 'hide', eval = FALSE}
pkgload::load_all(here::here('NEPSroutines'))
```

# Missing responses analyses

## Missing responses by person

### Separate functions

```{r missing responses by person with separate functions}
?NEPSroutines::mvp_analysis
mv_p <- NEPSroutines::mvp_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results'
)

?NEPSroutines::mvp_plots
NEPSroutines::mvp_plots(
  mv_p = mv_p,
  vars = vars,
  select = 'mixed',
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  labels_mvs = labels_mvs,
  path = 'Test/B129/Version 1.1.0/Plots/Missing_Responses/by_person',
  show_all = TRUE,
  #show_all = FALSE,
  name_grouping = 'test difficulty'#,
  #labels_legend = c('A', 'B', 'C')
)

?NEPSroutines::mvp_table
NEPSroutines::mvp_table(
  mv_p = mv_p,
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  save = FALSE,
  overwrite = TRUE,
  path = 'Test/B129/Version 1.1.0/Tables'
)

?NEPSroutines::print_mvp_results
NEPSroutines::print_mvp_results(mv_p)

rm(mv_p)
```

### Overaching functions

```{r missing responses by person}
NEPSroutines::mv_person(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  labels_mvs = labels_mvs,
  plots = FALSE,
  print = TRUE,
  save = FALSE,
  return = FALSE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_plots = 'Test/B129/Version 1.1.0/Plots/Missing_Responses/by_person',
  show_all = TRUE,
  overwrite = TRUE,
  warn = TRUE,
  verbose = TRUE
)
```

## Missing responses by item

### Separate functions

```{r missing responses by item with separate functions}
?NEPSroutines::mvi_analysis
mv_i <- NEPSroutines::mvi_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  grouping = c('easy', 'difficult'),
  position = c(easy = 'position_easy_mixed', difficult = 'position_difficult_mixed'),
  #position = 'position_mixed',
  mvs = mvs,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results'
)

?NEPSroutines::mvi_plots
mvi_plots(
  mv_i = mv_i,
  vars = vars,
  select = 'mixed',
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  path = 'Test/B129/Version 1.1.0/Plots/Missing_Responses/by_item',
  show_all = TRUE,
  #show_all = FALSE,
  name_grouping = 'test difficulty'#,
  #labels_legend = c('A', 'B', 'C')
)

?NEPSroutines::mvi_table
NEPSroutines::mvi_table(
  mv_i = mv_i,
  vars = vars,
  select = 'mixed',
  grouping = c('easy', 'difficult'),
  mvs = mvs,
  save = FALSE,
  overwrite = TRUE,
  path = 'Test/B129/Version 1.1.0/Tables'
)

?NEPSroutines::print_mvi_results
NEPSroutines::print_mvi_results(mv_i, labels_mvs = labels_mvs, name_grouping = 'test version')

rm(mv_i)
```

### Overaching functions


```{r missing responses by item}
NEPSroutines::mv_item(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  mvs = mvs[c(3, 1, 2, 4)],
  labels_mvs = labels_mvs,
  grouping = c('easy', 'difficult'),
  position = c(easy = 'position_easy_mixed', difficult = 'position_difficult_mixed'),
  plots = FALSE,
  print = TRUE,
  save = FALSE,
  return = FALSE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_plots = 'Test/B129/Version 1.1.0/Plots/Missing_Responses/by_item',
  show_all = TRUE,
  overwrite = TRUE,
  warn = TRUE,
  verbose = TRUE
)
```

# IRT analyses

## For all items

### Separate functions

```{r single IRT analysis with separate functions, eval = FALSE}
# Rasch and 2PL
?NEPSroutines::irt_model
rasch <- NEPSroutines::irt_model(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  irtmodel = '1PL',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all',
  pweights = NULL,
  #pweights = 'difficulty',
  control_tam = NULL,
  #control_tam = list(Msteps = 10, convM = 0.1), # wenn man snodes ver채ndert, wird eine Fehlermeldung ausgegeben
  control_wle = NULL
  #control_wle = list(Msteps = 10, convM = 0.1)
)

irt.2pl <- NEPSroutines::irt_model(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  irtmodel = '2PL',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all',
  pweights = NULL,
  #pweights = 'difficulty',
  control_tam = NULL,
  #control_tam = list(Msteps = 10, convM = 0.1), # wenn man snodes ver채ndert, funktioniert das Ganze nicht mehr
  control_wle = NULL
  #control_wle = list(Msteps = 10, convM = 0.1)
)

?NEPSroutines::icc_plots
NEPSroutines::icc_plots(
  model = rasch,
  path = 'Test/B129/Version 1.1.0/Plots',
  name_group = 'all'
)

?NEPSroutines::wright_map
NEPSroutines::wright_map(
  model = rasch,
  path = 'Test/B129/Version 1.1.0/Plots',
  name_group = 'all'
)

?NEPSroutines::irt_summary()
rasch_sum <- NEPSroutines::irt_summary(
  resp = resp,
  vars = vars,
  valid = 'valid',
  results = rasch,
  disc = irt.2pl,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Tables',
  name_group = 'all',
  overwrite = TRUE
)

?NEPSroutines::irt_model_fit()
NEPSroutines::irt_model_fit(
  model_1p = rasch,
  model_2p = irt.2pl,
  overwrite = TRUE,
  save = TRUE,
  path = 'Test/B129/Version 1.1.0/Tables',
  name_group = 'all'
)

?NEPSroutines::print_irt_summary
NEPSroutines::print_irt_summary(
  model = rasch,
  irt_sum = rasch_sum
)

rm(rasch, irt.2pl, rasch_sum)

# PCM and GPCM
?NEPSroutines::irt_model
pcm <- NEPSroutines::irt_model(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  irtmodel = 'PCM2',
  scoring = 'irt_scoring',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all',
  pweights = NULL,
  #pweights = 'difficulty',
  control_tam = NULL,
  #control_tam = list(Msteps = 10, convM = 0.1), # wenn man snodes ver채ndert, wird eine Fehlermeldung ausgegeben
  control_wle = NULL
  #control_wle = list(Msteps = 10, convM = 0.1)
)

gpcm <- NEPSroutines::irt_model(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  irtmodel = 'GPCM',
  scoring = 'irt_scoring',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all',
  pweights = NULL,
  #pweights = 'difficulty',
  control_tam = NULL,
  #control_tam = list(Msteps = 10, convM = 0.1), # wenn man snodes ver채ndert, funktioniert das Ganze nicht mehr
  control_wle = NULL
  #control_wle = list(Msteps = 10, convM = 0.1)
)

?NEPSroutines::icc_plots
NEPSroutines::icc_plots(
  model = pcm,
  path = 'Test/B129/Version 1.1.0/Plots',
  name_group = 'all'
)

?NEPSroutines::wright_map
NEPSroutines::wright_map(
  model = pcm,
  path = 'Test/B129/Version 1.1.0/Plots',
  name_group = 'all'
)

?NEPSroutines::irt_summary()
pcm_sum <- NEPSroutines::irt_summary(
  resp = resp,
  vars = vars,
  valid = 'valid',
  results = pcm,
  disc = gpcm,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Tables',
  name_group = 'all',
  overwrite = TRUE
)

?NEPSroutines::irt_model_fit()
NEPSroutines::irt_model_fit(
  model_1p = pcm,
  model_2p = gpcm,
  overwrite = FALSE,
  save = TRUE,
  path = 'Test/B129/Version 1.1.0/Tables',
  name_group = 'all'
)

?NEPSroutines::print_irt_summary
NEPSroutines::print_irt_summary(
  model = pcm,
  irt_sum = pcm_sum
)

rm(pcm, gpcm, pcm_sum)
```

### Overaching functions

```{r single IRT analysis, eval = FALSE}
# Rasch and 2PL
NEPSroutines::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  scoring = NULL,
  plots = FALSE,
  save = FALSE,
  print = TRUE,
  return = FALSE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_plots = 'Test/B129/Version 1.1.0/Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)

# PCM and GPCM
NEPSroutines::irt_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'irt_scoring',
  plots = FALSE,
  save = FALSE,
  print = TRUE,
  return = FALSE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_plots = 'Test/B129/Version 1.1.0/Plots',
  overwrite = TRUE,
  verbose = FALSE,
  name_group = 'all'
)
```


## For different test versions

```{r grouped IRT analysis}
# Rasch and 2PL
NEPSroutines::grouped_irt_analysis(
  groups = c(easy = 'dich_easy', difficult = 'dich_difficult', common = 'dich_common'),
  resp = resp,
  vars = vars,
  valid = 'valid',
  save = FALSE,
  print = TRUE,
  plots = FALSE,
  return = FALSE,
  overwrite = TRUE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_plots = 'Test/B129/Version 1.1.0/Plots'
)

# PCM and GPCM
NEPSroutines::grouped_irt_analysis(
  groups = c(easy = 'mixed_easy', difficult = 'mixed_difficult', common = 'mixed_common'),
  resp = resp,
  vars = vars,
  valid = 'valid',
  scoring = 'irt_scoring',
  save = FALSE,
  print = TRUE,
  plots = FALSE,
  return = FALSE,
  overwrite = TRUE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_plots = 'Test/B129/Version 1.1.0/Plots'
)
```


# DIF analysis

## Separate functions

```{r dif analysis with separate functions}
# For Rasch

## One DIF variable
?NEPSroutines::dif_model
dif_sex <- NEPSroutines::dif_model(
  resp = resp,
  vars = vars,
  select = 'dich',
  valid = 'valid',
  dif_var = 'sex',
  scoring = 'irt_scoring',
  include_mv = 200,
  control = NULL,
  #control = list(Msteps = 10, convM = 0.1),
  pweights = NULL,
  #pweights = 'difficulty',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all'
)

dif_diff <- NEPSroutines::dif_model(
  resp = resp,
  vars = vars,
  select = 'dich_common',
  valid = 'valid',
  dif_var = 'difficulty',
  scoring = 'irt_scoring',
  include_mv = 200,
  control = NULL,
  #control = list(Msteps = 10, convM = 0.1),
  pweights = NULL,
  #pweights = 'difficulty',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all'
)

?NEPSroutines::dif_summary
sex_sum <- NEPSroutines::dif_summary(
  diflist = dif_sex,
  vars = vars,
  #dif_threshold = 0.2,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Tables',
  overwrite = TRUE,
  name_group = 'all'
)

diff_sum <- NEPSroutines::dif_summary(
  diflist = dif_diff,
  vars = vars,
  #dif_threshold = 0.2,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Tables',
  overwrite = TRUE,
  name_group = 'all'
)

?NEPSroutines::build_dif_tr_tables
NEPSroutines::build_dif_tr_tables(
  dif_summaries = list(diff_sum = diff_sum,sex_sum = sex_sum),
  vars = vars,
  save = FALSE,
  overwrite = TRUE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Tables'
)

?NEPSroutines::print_dif_summary
NEPSroutines::print_dif_summary(
  resp,
  diflist = dif_sex,
  res = sex_sum,
  dif_threshold = 0.5
)

## Several DIF variables
?NEPSroutines::conduct_dif_analysis
dif_models <- NEPSroutines::conduct_dif_analysis(
  resp = resp,
  vars = vars,
  select = c('dich_common', 'dich', 'dich'),
  valid = 'valid',
  dif_vars = c('difficulty', 'sex', 'migration'),
  scoring = 'irt_scoring',
  include_mv = 200,
  #include_mv = 2,
  control = NULL,
  #control = list(Msteps = 10, convM = 0.1),
  pweights = NULL,
  #pweights = 'difficulty',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all'
)

?NEPSroutines::summarize_dif_analysis
dif_summaries <- NEPSroutines::summarize_dif_analysis(
  dif_models = dif_models,
  dif_vars = c('difficulty', 'sex', 'migration'),
  #dif_threshold = 0.2,
  save = FALSE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  overwrite = TRUE,
  name_group = 'all'
)

?NEPSroutines::build_dif_tr_tables
NEPSroutines::build_dif_tr_tables(
  dif_summaries = dif_summaries,
  save = FALSE,
  overwrite = TRUE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Tables'
)

rm(dif_sex, sex_sum, dif_models, dif_summaries)

# For PCM

## One DIF variable
?NEPSroutines::dif_model
dif_sex <- NEPSroutines::dif_model(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  dif_var = 'sex',
  scoring = 'irt_scoring',
  include_mv = 200,
  control = NULL,
  #control = list(Msteps = 10, convM = 0.1),
  pweights = NULL,
  #pweights = 'difficulty',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all'
)

?NEPSroutines::dif_summary
sex_sum <- NEPSroutines::dif_summary(
  diflist = dif_sex,
  #dif_threshold = 0.2,
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Tables',
  overwrite = TRUE,
  name_group = 'all'
)

?NEPSroutines::print_dif_summary
NEPSroutines::print_dif_summary(
  resp,
  diflist = dif_sex,
  res = sex_sum,
  dif_threshold = 0.5
)

## Several DIF variables
?NEPSroutines::conduct_dif_analysis
dif_models <- NEPSroutines::conduct_dif_analysis(
  resp = resp,
  vars = vars,
  select = c('mixed_common', 'mixed', 'mixed'),
  valid = 'valid',
  dif_vars = c('difficulty', 'sex', 'migration'),
  scoring = 'irt_scoring',
  include_mv = 200,
  #include_mv = 2,
  control = NULL,
  #control = list(Msteps = 10, convM = 0.1),
  pweights = NULL,
  #pweights = 'difficulty',
  save = FALSE,
  path = 'Test/B129/Version 1.1.0/Results',
  name_group = 'all'
)

?NEPSroutines::summarize_dif_analysis
dif_summaries <- NEPSroutines::summarize_dif_analysis(
  dif_models = dif_models,
  dif_vars = c('difficulty', 'sex', 'migration'),
  #dif_threshold = 0.2,
  save = FALSE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables',
  overwrite = TRUE,
  name_group = 'all'
)

?NEPSroutines::build_dif_tr_tables
NEPSroutines::build_dif_tr_tables(
  dif_summaries = dif_summaries,
  save = FALSE,
  overwrite = TRUE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Tables'
)

rm(dif_sex, sex_sum, dif_models, dif_summaries)
```

## Overarching functions

```{r dif analysis}

vars <- vars[c(171:172, 1:170), ]

# For Rasch
dif <- NEPSroutines::dif_analysis(
  resp = resp,
  vars = vars,
  select = c('dich_common', 'dich', 'dich'),
  valid = 'valid',
  dif_vars = c('difficulty', 'sex', 'migration'),
  scoring = 'irt_scoring',
  overwrite = TRUE,
  print = TRUE,
  verbose = FALSE,
  save = TRUE,
  return = TRUE,
  digits = 2,
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_results = 'Test/B129/Version 1.1.0/Results'
)

# For PCM
NEPSroutines::dif_analysis(
  resp = resp,
  vars = vars,
  select = c('mixed_common', 'mixed', 'mixed'),
  valid = 'valid',
  dif_vars = c('difficulty', 'sex', 'migration'),
  scoring = 'irt_scoring',
  overwrite = TRUE,
  print = TRUE,
  verbose = FALSE,
  save = FALSE,
  return = FALSE,
  path_table = 'Test/B129/Version 1.1.0/Tables',
  path_results = 'Test/B129/Version 1.1.0/Results'
)
```


# Distractor analysis

## Separate functions

```{r distractor analysis with separate functions}
?NEPSroutines::conduct_dis_analysis
dis <- NEPSroutines::conduct_dis_analysis(
  resp = resp,
  vars = vars,
  valid = 'valid',
  select_raw = 'distan',
  select_score = 'dich',
  #select_score = 'mixed',
  save = FALSE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Results'
)

?NEPSroutines::dis_summary
dis_sum <- NEPSroutines::dis_summary(
  dis,
  save = FALSE,
  overwrite = TRUE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Tables'
)

?NEPSroutines::print_dis_summary
NEPSroutines::print_dis_summary(dis_sum)

rm(dis, dis_sum)
```

## Overarching functions

```{r distractor analysis}
NEPSroutines::dis_analysis(
  resp = resp,
  vars = vars,
  valid = 'valid',
  select_raw = 'distan',
  print = TRUE,
  save = FALSE,
  overwrite = TRUE,
  path_results = 'Test/B129/Version 1.1.0/Results',
  path_table = 'Test/B129/Version 1.1.0/Tables'
)
```


# Dimension analysis

## Separate functions

```{r dimensionality analysis with separate functions}
?NEPSroutines::conduct_dim_analysis
dim <- NEPSroutines::conduct_dim_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'dim_scoring',
  dim = c('kog_type', 'text_type'),
  irtmodel = 'PCM2',
  maxiter = 10,
  snodes = 5,
  save = FALSE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Results'
)

?NEPSroutines::dim_summary
dim_sum <- NEPSroutines::dim_summary(
  dim,
  save = FALSE,
  overwrite = TRUE,
  name_group = 'all',
  path = 'Test/B129/Version 1.1.0/Tables'
)

?NEPSroutines::print_dim_summary
NEPSroutines::print_dim_summary(dim_sum)

rm(dim, dim_sum)
```

## Overarching functions

```{r dimensionality analysis}
dim <- NEPSroutines::dim_analysis(
  resp = resp,
  vars = vars,
  select = 'mixed',
  valid = 'valid',
  scoring = 'dim_scoring',
  irtmodel = 'PCM2',
  maxiter = 10,
  snodes = 5,
  verbose = FALSE,
  return = TRUE,
  save = FALSE,
  print = TRUE,
  path_table = 'Test/B129/Version 1.1.0/Tables', 
  path_results = 'Test/B129/Version 1.1.0/Results',
  overwrite = TRUE,
  dim = c('kog_type', 'text_type')
)
```
